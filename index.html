<html>
<head>
    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
 	
 	<link rel="stylesheet" href="mylibs/jquery.mobile-1.0/jquery.mobile-1.0.min.css" />
 	<script type="text/javascript" src="mylibs/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="mylibs/jquery.mobile-1.0/jquery.mobile-1.0.min.js"></script>
	<script type="text/javascript" src="mylibs/kinetic-v5.1.0.min.js"></script>
	
 
  </head>
<body>
<div id ="container"></div>

   <fieldset class="ui-grid-a">
   <div class="ui-block-c"><button id="cameraImage" data-theme="a">Camera</button></div>
	<div class="ui-block-c"><button id="loadImage" data-theme="a">Load</button></div>
	<div class="ui-block-c"><button id="cropImage"data-theme="a">Crop</button></div>
    <div class="ui-block-c"><button id="textImage" data-theme="a">Text</button></div>
	<div class="ui-block-c"><button id="shapeImage" data-theme="a">Shape</button></div>
	 <div class="ui-block-c"><button id="imgImage" data-theme="a">Image</button></div>
	 <div class="ui-block-c"><button id="brushImage" data-theme="a">Brush</button></div>
    <div class="ui-block-c"><button id="saveImage" data-theme="a">Save</button></div>	
	<div class="ui-block-c"><button id="rotateImage" data-theme="a">rotate</button></div>	
	<div class="ui-block-c"><button id="scrollImage" data-theme="a">scroll</button></div>	
	<div class="ui-block-c"><button id="zoomImage" data-theme="a">zoom</button></div>	
   </fieldset>
     <!--
      <input type="button" id="loadImage" value="Load Image" width="100">
	  <input type="button" id="cropImage" value="Crop">
	  <input type="button" id="textImage" value="Text">
	  <input type="button" id="saveImage" value="Save Image">
    -->
	
  <script src="kinetic-v5.1.0.js"></script>
  <script>
    var stage = new Kinetic.Stage({
        container: 'container',
        width    : 1048,
        height   : 668,
		draggable: true,
		 offset: [524, 334]
    });

    var layer = new Kinetic.Layer();
	
	
	  var imageObj = new Image();
      imageObj.onload = function() {
      var backImg = new Kinetic.Image({
          x: 0,
          y: 0,
          image: imageObj,
          //width: stage.getWidth(),
          //height: stage.getHeight()
		});
		 
        layer.add(backImg);
		layer.draw();
        //stage.add(layer);
		};
		
         imageObj.src = 'bg.png';
		 /*
		 var lastDist = 0;
         var startScale = 1;
		 stage.getContent().addEventListener('touchmove', function(evt) {
        var touch1 = evt.touches[0];
        var touch2 = evt.touches[1];

        if(touch1 && touch2) {
          var dist = getDistance({
            x: touch1.clientX,
            y: touch1.clientY
          }, {
            x: touch2.clientX,
            y: touch2.clientY
          });

          if(!lastDist) {
            lastDist = dist;
          }

          //var scale = stage.getScale().x * dist / lastDist;

		  var scale = {
            x: stage.scale().x * dist / lastDist,
            y: stage.scale().y * dist / lastDist
        };
          stage.setScale(scale);
          stage.draw();
          lastDist = dist;
        }
      }, false);

      stage.getContent().addEventListener('touchend', function() {
        lastDist = 0;
      }, false);
	  */
	  
	 
	  stage.add(layer);
	  
	  
	  
	  stage.draw();
	  
	  
	  
     /*
     var mY = 0;

function update(activeAnchor, event) {
    var group = activeAnchor.getParent();
    var sizeAnchor = group.get('.sizeAnchor')[0];
    var text = group.get('.text')[0];

    if (event.pageY < mY) {
        text.setFontSize(text.getFontSize() - 1);
    } else {
        text.setFontSize(text.getFontSize() + 1);
    }

    sizeAnchor.setPosition(-10, 0);

    mY = event.pageY;
}

function addAnchor(group, x, y, name) {
    var stage = group.getStage();
    var layer = group.getLayer();

    var anchor = new Kinetic.Circle({
        x: x,
        y: y,
        stroke: '#666',
        fill: '#ddd',
        strokeWidth: 2,
        radius: 8,
        name: name,
        draggable: true,
        dragOnTop: false,
        dragBoundFunc: function (pos) {
            return {
                x: this.getAbsolutePosition().x,
                y: pos.y
            };
        }
    });

    anchor.on('dragmove', function (e) {
        var mousePos = stage.getMousePosition();

        update(this, e);
        layer.draw();
    });
    anchor.on('mousedown touchstart', function () {
        group.setDraggable(false);
        this.moveToTop();
    });
    anchor.on('dragend', function () {
        group.setDraggable(true);
        layer.draw();
    });
    // add hover styling
    anchor.on('mouseover', function () {
        var layer = this.getLayer();
        document.body.style.cursor = 'pointer';
        this.setStrokeWidth(4);
        layer.draw();
    });
    anchor.on('mouseout', function () {
        var layer = this.getLayer();
        document.body.style.cursor = 'default';
        this.setStrokeWidth(2);
        layer.draw();
    });

    group.add(anchor);
}

function initStage(images) {
   
    var textGroup = new Kinetic.Group({
        x: 100,
        y: 100,
        draggable: true,
        dragBoundFunc: function (pos) {
            return {
                x: this.getAbsolutePosition().x,
                y: pos.y
            };
        }
    });
   
    layer.add(textGroup);
    stage.add(layer);

    var text = new Kinetic.Text({
        x: 0,
        y: 0,
        text: "Euro group",
        fill: "#000",
        fontSize: 12,
        name: 'text'
    });

    textGroup.add(text);
    addAnchor(textGroup, -10, 0, 'sizeAnchor');

    stage.draw();
}
*/

	
	
function drawImage()
{
 var myimage = new Image();
 myimage.src = "bird.png";
 
 
 var imageGroup = new Kinetic.Group({
        x: 100,
        y: 100,
        draggable: true,
        dragBoundFunc: function (pos) {
            return {
                x: this.getAbsolutePosition().x,
                y: pos.y
            };
        }
    });
 var image = new Kinetic.Image({
        x: 100,
        y: 100,
        image : myimage,
        draggable: true
       
        
    });
	

	imageGroup.add(image);
	layer.add(imageGroup);
}
function drawImageRotate()
{
 var myimage = new Image();
 myimage.src = "bird.png";
 
 
 var imageGroup = new Kinetic.Group({
        x: 100,
        y: 100,
        draggable: true,
        dragBoundFunc: function (pos) {
            return {
                x: this.getAbsolutePosition().x,
                y: pos.y
            };
        }
    });
 var image = new Kinetic.Image({
        x: 100,
        y: 100,
        image : myimage,
        draggable: true
       
        
    });
	
    image.rotateDeg(90);

	imageGroup.add(image);
	layer.add(imageGroup);
}

function drawCrop()
{
 var cropGroup = new Kinetic.Group({
        x: 100,
        y: 100,
        draggable: true,
        dragBoundFunc: function (pos) {
            return {
                x: this.getAbsolutePosition().x,
                y: pos.y
            };
        }
    });
var rect = new Kinetic.Rect({
    width: stage.getWidth()/2,
    height: stage.getHeight()/2,
    x: 200,
    y: 200,
    stroke: 'blue',
    strokeWidth: 2,
	 draggable: true
});
	 cropGroup.add(rect);
	layer.add(cropGroup);
}


function drawShape()
{
 var shapeGroup = new Kinetic.Group({
        x: 100,
        y: 100,
        draggable: true,
        dragBoundFunc: function (pos) {
            return {
                x: this.getAbsolutePosition().x,
                y: pos.y
            };
        }
    });
 var circle = new Kinetic.Circle({
        x: 100,
        y: 100,
        stroke: '#666',
        fill: '#ddd',
        strokeWidth: 2,
        radius: 25,
      
        draggable: true
       
        
    });
	 shapeGroup.add(circle);
	layer.add(shapeGroup);
}
function initStage(message) {
   /*
    var textGroup = new Kinetic.Group({
        x: 100,
        y: 100,
        draggable: true,
        dragBoundFunc: function (pos) {
            return {
                x: this.getAbsolutePosition().x,
                y: pos.y
            };
        }
    });
   
    */

      var messageText = new Kinetic.Text({
			  x: .25*stage.getWidth(),
			  y: .25*stage.getHeight(), 
        width: .2*stage.getWidth(),
        height: .2*stage.getHeight(),
        fontSize: 24,
		    fontFamily: 'Lucida Grande',
		    text: message,
		    align: 'center',
		    textFill: 'green',
      	stroke: 'green',
        draggable: true,
		  	fill: 'green',
	    });
		 //textGroup.add(messageText);
		// layer.add(textGroup);
		layer.add(messageText);
		 // stage.draw();
		 }
	 
	    
    var background = new Kinetic.Rect({
    x: 0,
    y: 0,
    width: stage.getWidth(),
    height: stage.getHeight(),
    fill: 'white',
    stroke: 'black',
    strokeWidth: 1,
})
//layer.add(background);
//layer.draw();

// a flag we use to see if we're dragging the mouse
var isMouseDown = false;
// a reference to the line we are currently drawing
var newline;
// a reference to the array of points making newline
var points = [];

// on the background
// listen for mousedown, mouseup and mousemove events


// On mousedown
// Set the isMouseDown flag to true
// Create a new line,
// Clear the points array for new points
// set newline reference to the newly created line
function onMousedown(event) {
   
    isMouseDown = true;
    points = [];
	//alert (stage.getPointerPosition());
    points.push(stage.getPointerPosition());
	//alert("OK");
    var line = new Kinetic.Line({
        points: points,
        stroke: "green",
        strokeWidth: 5,
        lineCap: 'round',
        lineJoin: 'round'
    });
	
    layer.add(line);
    newline = line;
	//alert (newline);
	 
}

// on mouseup end the line by clearing the isMouseDown flag
function onMouseup(event) {
    isMouseDown = false;
	//alert ("OK");
}

// on mousemove
// Add the current mouse position to the points[] array
// Update newline to include all points in points[]
// and redraw the layer
function onMousemove(event) {
    if (!isMouseDown) {
        return;
    };
    points.push(stage.getPointerPosition());
    newline.setPoints(points);
    layer.drawScene();
    // this is faster since the "hit" canvas is not refreshed
	//alert ("draw");
    //layer.draw();
}
		
		
		function makePos(x, y) {
    return {
        'x': x,
        'y': y
    };
}


function View() {
    this.init = init;

    var self = this;

    var kineticStage,
        kineticLayer,
        kineticTextLayer,

        zoomOrigin = makePos(0, 0),
        zoomFactor = 1.1,
        pinchLastDist, pinchStartCenter;

    init();

    function init() {

        // disable ipad zoom to prevent safari from zooming on orientation change
        $('head meta[name=viewport]').remove();
        $('head').prepend('<meta name="viewport" content="user-scalable=no, width=device-width, minimum-scale=1.0 , initial-scale=1.0, maximum-scale=1.0" />');

        /*create stage layer and circle
        kineticStage = new Kinetic.Stage({
            container: 'container',
            width: $(document).width() - 10,
            height: $(document).height() - 10,
        });

        kineticLayer = new Kinetic.Layer({
            draggable: true
        });*/
        var circle = new Kinetic.Circle({
            x: 200,
            y: 200,
            radius: 50,
            fill: '#00D200',
            stroke: 'black',
            strokeWidth: 2,
        });
        layer.add(circle);
        stage.add(layer);

        kineticTextLayer = new Kinetic.Layer({});
        stage.add(kineticTextLayer);

        // register events and proxy to methods
        $(stage.content).on('mousewheel', function(e) {
            e.preventDefault();
            var evt = e.originalEvent;
            stageMouseWheel.call(self, evt.deltaY, makePos(evt.clientX, evt.clientY));
        });
		
        stage.getContent().addEventListener('touchmove', function(e) {
            e.preventDefault(); // prevent iPAD panning
            var touch1 = e.touches[0];
            var touch2 = e.touches[1];
            if (touch1 && touch2) {
                touch1.offsetX = touch1.pageX - $(touch1.target).offset().left;
                touch1.offsetY = touch1.pageY - $(touch1.target).offset().top;
                touch2.offsetX = touch2.pageX - $(touch2.target).offset().left;
                touch2.offsetY = touch2.pageY - $(touch2.target).offset().top;
                stagePinch.call(self, makePos(touch1.offsetX, touch1.offsetY), makePos(touch2.offsetX, touch2.offsetY));
            }
        }, false);
        stage.getContent().addEventListener('touchend', function(e) {
            stageTouchEnd.call(self);
        }, false);

        $(window).on("orientationchange", function(event) {
            window.scrollTo(0, 0); // scroll to top left on orientation change
        });

        editTextLayer('scrollwheel/pinch to zoom');
        window.scrollTo(0, 0);
    }

    function zoom(newscale, center) { // zoom around center
        var mx = center.x - layer.getX(),
            my = center.y - layer.getY(),
            oldscale = layer.getScaleX();
        editTextLayer('zoom ' + newscale.toFixed(2) + ' around ' + mx.toFixed(2) + ',' + my.toFixed(2));

        zoomOrigin = makePos(mx / oldscale + zoomOrigin.x - mx / newscale, my / oldscale + zoomOrigin.y - my / newscale);
console.log(zoomOrigin.x + ' ' + zoomOrigin.y);
        layer.offset(makePos(zoomOrigin.x, zoomOrigin.y));
        layer.scale({
            x: newscale,
            y: newscale
        });
        layer.draw();
    }

    function stageMouseWheel(factor, p) {
        var oldscale = layer.getScaleX(),
            newscale = oldscale * (zoomFactor - (factor < 0 ? 0.2 : 0));
        zoom(newscale, p);
    }

    function stagePinch(p1, p2) {
        var dist = Math.sqrt(Math.pow((p2.x - p1.x), 2) + Math.pow((p2.y - p1.y), 2));
        if (!pinchLastDist) pinchLastDist = dist;
        var newscale = layer.getScale().x * dist / pinchLastDist;

        var center = makePos(Math.abs((p1.x + p2.x) / 2), Math.abs((p1.y + p2.y) / 2));
        if (!pinchStartCenter) pinchStartCenter = center;

        zoom(newscale, pinchStartCenter);
        pinchLastDist = dist;
    }

    function stageTouchEnd() {
        pinchLastDist = pinchStartCenter = 0;
    }

    function editTextLayer(text) {
        var label = new Kinetic.Text({
            x: 0,
            y: 0,
            text: text,
            fontSize: 12,
            fontFamily: 'Calibri',
            fill: 'black'
        });

        kineticTextLayer.destroyChildren();
        kineticTextLayer.add(label);
        kineticTextLayer.drawScene();
    }
}




		

	   function getDistance(p1, p2) {
        return Math.sqrt(Math.pow((p2.x - p1.x), 2) + Math.pow((p2.y - p1.y), 2));
      }
	
	 document.getElementById('cropImage').addEventListener('click', function() {
         alert ("Crop image");
		 drawCrop();
		 layer.draw();
        });
	 document.getElementById('textImage').addEventListener('click', function() {
         //alert ("Text image");
		   initStage("Euro Group");
		   layer.draw();
		  //layer.add(messageText);
		  //layer.add(textGroup);
		 // messageText.setText('Euro Group');
          //messageText.setFontSize(messageText.getHeight()/2);
          //messageText.setPadding(messageText.getHeight()/5); //this was one possibility to do some alignment
         
        });
	 document.getElementById('saveImage').addEventListener('click', function() {
	 //alert ("save");
	 //var layer = new Kinetic.Layer();
	 layer.add(background);
     layer.draw();
        background.on('mousedown', function () {
                onMousedown();
              });
           background.on('mouseup', function () {
                onMouseup();
            });
             background.on('mousemove', function () {
                onMousemove();
                });
        });
		
		document.getElementById('shapeImage').addEventListener('click', function() {
         alert ("Shape");
		 drawShape();
		 stage.draw();
        });
		
		document.getElementById('imgImage').addEventListener('click', function() {
         alert ("Image");
		 drawImage();
		 stage.draw();
        });
		
		document.getElementById('rotateImage').addEventListener('click', function() {
         alert ("Image");
		 drawImageRotate();
		 stage.draw();
        });
		
		document.getElementById('scrollImage').addEventListener('click', function() {
         alert ("scroll");
		 stage.setDraggable(false);
		 stage.draw();
        });
		
		 document.getElementById('zoomImage').addEventListener('click', function() {
         alert ("Zoom image");
		 var view = new View();
		 
        });
		
		document.addEventListener("deviceready",onDeviceReady,false);
    
    var pictureSource;   
	var destinationType; 
    
    
    function onDeviceReady() {
	
	    var capture_btn = $('#cameraImage');
		var getImg_btn = $('#loadImage');
		
	     
        pictureSource=navigator.camera.PictureSourceType;
        destinationType=navigator.camera.DestinationType;
            
		
        capture_btn.click(function(){
		    //alert ("camera start");
        	capturePhoto();
			});
			
			
		 getImg_btn.click(function(){
        	getImage(pictureSource.SAVEDPHOTOALBUM);
        });
        
        
    function onPhotoDataSuccess(imageData) {
      alert ("Captured success");
	  imageObj.src = imageData;
	  layer.draw();
	 /*
	  var returnedImg = new Image();
	  
	  returnedImg.onload = function() {
      layer.clear();
      var camImg = new Kinetic.Image({
          x: 0,
          y: 0,
         image: returnedImg
         
		});
		};
		
	   
		  returnedImg.src = imageData;
	    alert ("ok");
	 
	   layer.add(camImg);
	   stage.add(layer);
	   layer.draw();
	  */
    }
	
	
    function onPhotoURISuccess(imageURI) {
    
      alert ("Captured success");
	  imageObj.src = imageURI;
	  layer.draw();
    }

    function onFail(message) {
      alert('Failed because: ' + message);
    }
	
    function capturePhoto() {
	  //alert ("ready 1 2 3");
      navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 50 ,destinationType: destinationType.FILE_URI });
    }	
	
    function getImage(source) {
        navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, 
        destinationType: destinationType.FILE_URI,
        sourceType: source });
    }	
   }

   </script>
</body>
</html>